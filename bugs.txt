
# Fixed: added sleep for rateLimit milliseconds after every call to market
Bug #1:
Cause: too many requests sent to a ref exchange in a short period of time
Solution:
-1) reduce the calls to the ref exchange. Checking the price for the ref exchange every 5 min is fine. You can get the price for the reference markets, save it, and use it for the next 5min. Then you can request the price again and update it.
This should not affect the spread checking. Spread checking should be done in shorter period.

-2) Handle the thrown exception -> log msg " Too many requests sent to #exchangeName" => Retry after randometime between 3min and 5min. If after second try we get same error increase wait time +2 min. Always do that until the request is successful
==> Use this error handling for all api request, also for Lykke. The program should keep working even after such errors!
		


Bug error msg:

INFO:root:Found placed orders
INFO:root:checking current bid status a3e6997c-d78c-4908-807f-8a234ee78d98 : canceled
and ask status f240c0cb-df9a-4982-b8ff-a08145ea2b17 : canceled 

INFO:root:Orders are already closed. Deleting from dict 'placed_orders'...
INFO:root:going to sleep for: 15
INFO:root:Entering place_orders func, pair: WAX/ETH
Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/urllib3/connectionpool.py", line 387, in _make_request
    six.raise_from(e, None)
  File "<string>", line 2, in raise_from
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/urllib3/connectionpool.py", line 383, in _make_request
    httplib_response = conn.getresponse()
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/http/client.py", line 1331, in getresponse
    response.begin()
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/http/client.py", line 297, in begin
    version, status, reason = self._read_status()
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/http/client.py", line 258, in _read_status
    line = str(self.fp.readline(_MAXLINE + 1), "iso-8859-1")
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/socket.py", line 586, in readinto
    return self._sock.recv_into(b)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/ssl.py", line 1009, in recv_into
    return self.read(nbytes, buffer)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/ssl.py", line 871, in read
    return self._sslobj.read(len, buffer)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/ssl.py", line 631, in read
    v = self._sslobj.read(len, buffer)
socket.timeout: The read operation timed out

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/requests/adapters.py", line 440, in send
    timeout=timeout
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/urllib3/connectionpool.py", line 639, in urlopen
    _stacktrace=sys.exc_info()[2])
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/urllib3/util/retry.py", line 357, in increment
    raise six.reraise(type(error), error, _stacktrace)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/urllib3/packages/six.py", line 686, in reraise
    raise value
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/urllib3/connectionpool.py", line 601, in urlopen
    chunked=chunked)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/urllib3/connectionpool.py", line 389, in _make_request
    self._raise_timeout(err=e, url=url, timeout_value=read_timeout)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/urllib3/connectionpool.py", line 309, in _raise_timeout
    raise ReadTimeoutError(self, url, "Read timed out. (read timeout=%s)" % timeout_value)
urllib3.exceptions.ReadTimeoutError: HTTPSConnectionPool(host='bittrex.com', port=443): Read timed out. (read timeout=10)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/base/exchange.py", line 357, in fetch
    proxies=self.proxies
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/requests/sessions.py", line 508, in request
    resp = self.send(prep, **send_kwargs)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/requests/sessions.py", line 618, in send
    r = adapter.send(request, **kwargs)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/requests/adapters.py", line 521, in send
    raise ReadTimeout(e, request=request)
requests.exceptions.ReadTimeout: HTTPSConnectionPool(host='bittrex.com', port=443): Read timed out. (read timeout=10)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "main.py", line 115, in <module>
    place_orders(lykke, placed_orders, coin2_spend_amount, coin1_spend_amount, pair)
  File "main.py", line 19, in place_orders
    ref_book = ref_market.fetch_order_book(pair)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/bittrex.py", line 241, in fetch_order_book
    }, params))
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/bittrex.py", line 680, in request
    response = self.fetch2(path, api, method, params, headers, body)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/base/exchange.py", line 303, in fetch2
    return self.fetch(request['url'], request['method'], request['headers'], request['body'])
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/base/exchange.py", line 367, in fetch
    self.raise_error(RequestTimeout, method, url, e)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/base/exchange.py", line 288, in raise_error
    raise exception_type(output)
ccxt.base.errors.RequestTimeout: bittrex GET https://bittrex.com/api/v1.1/public/getorderbook?market=ETH-WAX&type=both HTTPSConnectionPool(host='bittrex.com', port=443): Read timed out. (read timeout=10)



# Fixed: if bid order is placed and ask order is not or vice versa, then that one order is canceled and deleted from dict
Bug#2:
Cause: If sell order is already placed -> Then start the program -> it will lead to the following error:
Saids-MBP:lykke_market_maker said.salem$ python3.6 main.py 
Traceback (most recent call last):
  File "main.py", line 8, in <module>
    placed_orders = init_placed_orders(lykke)
  File "/Users/said.salem/ownCloud/Trading/LykkeAPI/lykke_market_maker/common.py", line 73, in init_placed_orders
    placed_orders[pair] = Orders(orders_pair["bid"], orders_pair["ask"])
KeyError: 'bid'

Cause 2: If buy order is placed:

Saids-MBP:lykke_market_maker said.salem$ python3.6 main.py 
Traceback (most recent call last):
  File "main.py", line 8, in <module>
    placed_orders = init_placed_orders(lykke)
  File "/Users/said.salem/ownCloud/Trading/LykkeAPI/lykke_market_maker/common.py", line 73, in init_placed_orders
    placed_orders[pair] = Orders(orders_pair["bid"], orders_pair["ask"])
KeyError: 'ask'




# The problem was in placing order with amount that's below minimal size
# Fixed function check_min_size
# Balance is always divided to the parts, and each part is used to place order, so problem with insufficiency of money
# on balance shouldn't arise
Bug3#:
Cause:If Balance not enough:
Solution: Check Balance before putting orders
          - And error handling. Program should not exit!

Bug error msg:

INFO:root:Is situation relevant?: True

INFO:root:No orders were found. Placing orders...
Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/base/exchange.py", line 364, in fetch
    response.raise_for_status()
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/requests/models.py", line 935, in raise_for_status
    raise HTTPError(http_error_msg, response=self)
requests.exceptions.HTTPError: 400 Client Error: Bad Request for url: https://hft-api.lykke.com/api/Orders/limit

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "main.py", line 115, in <module>
    place_orders(lykke, placed_orders, coin2_spend_amount, coin1_spend_amount, pair)
  File "main.py", line 88, in place_orders
    bid_id = market.create_limit_buy_order(pair, converted_buy_amount, bid_price)['info']
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/base/exchange.py", line 1220, in create_limit_buy_order
    return self.create_order(symbol, 'limit', 'buy', *args)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/lykke.py", line 132, in create_order
    result = getattr(self, method)(self.extend(query, params))
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/base/exchange.py", line 306, in request
    return self.fetch2(path, api, method, params, headers, body)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/base/exchange.py", line 303, in fetch2
    return self.fetch(request['url'], request['method'], request['headers'], request['body'])
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/base/exchange.py", line 377, in fetch
    self.handle_rest_errors(e, response.status_code, self.last_http_response, url, method)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/base/exchange.py", line 406, in handle_rest_errors
    self.raise_error(error, url, method, exception if exception else http_status_code, response)
  File "/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages/ccxt/base/exchange.py", line 288, in raise_error
    raise exception_type(output)
ccxt.base.errors.ExchangeNotAvailable: lykke https://hft-api.lykke.com/api/Orders/limit POST 400 Client Error: Bad Request for url: https://hft-api.lykke.com/api/Orders/limit {"Error":{"Code":"Dust","Field":null,"Message":"The amount should be higher than minimal order size 2.5 WAX"}}
